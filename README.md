Matching Model with side independent

Matching Model with side independent

Для того что бы цена сделки была справедливой необходимо каждому участнику предоставить равные возможности, в зависимости от его намерений,
которые он способен формировать в конкурентной среде и ясными правилами.

За основу возьмём выбор заявок основанный по двум критериями: цена и время - это определит очередность заявок.
Ценобразование определим как сделку с наименьшими потерями для обоих сторон сделки. 

Это основные правила, интерполируем их для закрытия "белых пятен" на случаи рынка с независимым и равноправным доступом к торгам,
с двумя типами заявок: рыночной и лимитированной.

Будем считать что рыночная заявка имеет наивысший приоритет по цене и первая вступает в сделку,
а по направлению рыночные друг с другом не конкурируют, значит их можно матчить независимо: покупки и продажи,
рассматривая все как равноприоритетные (по одной цене и в одно время).

Таким образом рыночная заявка - это заявка с минимальными правами, отправив в рынок она обязательно будет исполнена,
а лимитированная даёт право на сделку по фиксированной цене, или лучше.

Подробней рассмотрим лимитированные заявки и разберём ситуацию, внутри спреда (предположим 20-21) прилетают заявки в один тик: 

Пример 1
Orders
+----+------+-----+-------+
| ID | SIDE | QTY | PRICE |
+----+------+-----+-------+
| #1 | SELL | 150 | 20.20 |
| #2 | SELL | 100 | 20.30 |
| #3 | BUY  | 250 | 20.40 |
+----+------+-----+-------+

Они все готовы заключить между собой сделки, не затронув ткущий рынок, и в данном случае они могут
договориться по средней цена. А задача матчера - это как раз помочь договориться!

Executions
+----+------+-------+-----+-------+-------+------+----+
| ID | SIDE | TYPE  | QTY | PRICE | TYPE  | SIDE | ID |
+----+------+-------+-----+-------+-------+------+----+
| #3 | BUY  | TAKER | 150 | 20.30 | TAKER | SELL | #1 |
| #3 | BUY  | TAKER | 100 | 20.35 | TAKER | SELL | #2 |
+----+------+-------+-----+-------+-------+------+----+

Пока всё просто, сузим спред предварительной заявкой SELL 50@20.30

Пример 2
Orders book
+----+------+------+-----+-------+-----+---------+------+
| ID | SIDE | TIME | QTY | PRICE | QTY |  TIME   | SIDE |
+----+------+------+-----+-------+-----+---------+------+
| #1 |      |      |     | 20.30 |  50 | 12:05PM | SELL |
+----+------+------+-----+-------+-----+---------+------+

Orders
+----+------+-----+-------+
| ID | SIDE | QTY | PRICE |
+----+------+-----+-------+
| #2 | SELL | 150 | 20.20 |
| #3 | SELL | 100 | 20.30 |
| #4 | BUY  | 250 | 20.40 |
+----+------+-----+-------+

Executions
+----+------+-------+-----+-------+-------+------+----+
| ID | SIDE | TYPE  | QTY | PRICE | TYPE  | SIDE | ID |
+----+------+-------+-----+-------+-------+------+----+
| #2 | SELL | TAKER | 150 | 20.25 | TAKER | BUY  | #4 |
| #1 | SELL | MAKER |  50 | 20.30 | TAKER | BUY  | #4 |
| #3 | SELL | TAKER |  50 | 20.30 | TAKER | BUY  | #4 |
+----+------+-------+-----+-------+-------+------+----+


Final orders book
+----+------+------+-----+-------+-----+---------+------+
| ID | SIDE | TIME | QTY | PRICE | QTY |  TIME   | SIDE |
+----+------+------+-----+-------+-----+---------+------+
| #3 |      |      |     | 20.30 |  50 | 12:15PM | SELL |
+----+------+------+-----+-------+-----+---------+------+

Ожидаемый результат книги заявок, а порядок сделок такой что ушла заявка которая была в книге,
вместо неё по той же цене встала новая, цены в сделках не хуже заявленных и в рамках спреда

Такой пример показывает что существует проблема матчинга перекрёстных заявок из одного тика,
и как на них влияет спред стакана, и что сделки для обоих сторон можно провести лучше заявленных цен,
при этом соблюдена очерёдность и правила модели.


Что бы воспользоваться моделью необходимо научиться выявлять подобные ситуации в более сложных начальных данных.
Нельзя просто начать матчить заявки с концов потому что во первых: цена не может быть усреднённой,
а должна вписываться в формируемый в этом тике стакан, во вторых,
мы можем столкнуться с уже зарегистрированной сделкой в стакане, для которой цена определена!

Для того что бы разрешить эти противоречия, необходимо получить оценку,
каким же будет стакан по окончанию тика, для этого рассмотрим функцию:

Кумулятивная функция (КФ) покупателя - определяет количество лотов готовых к покупке по цене лучше или текущей включительно.
Для стакана - это глубина (где на противоположной стороне, выше бида одни нули).
Что известно об этой функции? Она монотонная, дискретная, не возрастающая функция,
в бесконечности рана 0. КФ продавца - монотонная, дискретная, не убывающая, в 0 равная 0.

По ним можно спрогнозировать какой будет стакан, что даёт возможность сформировать справедливую цену при сделках.

Рассмотрим когда КФ пересекаются, в противном случае сделок нет!

B = Argmax_x(K_b(x) > K_a(x))
A = Argmin_x(K_a(x) > K_b(x))

B - это бид будущего стакана
A - аск будущего стакана

Необходимо что бы были строгие равенства, тк K_b(x) = K_a(x) - то это цена внутри спреда,
в которой нет заявок, либо офсетные заявки по одинаковой цене, которым никто не будет мешать исполниться (их может быть только две)


Теперь зная B и A, можем начать проводить сделки для пересекающихся заявок,
усредняя их цену, но оставляя в рамках этих ограничений.
Но это ещё не всё: в какой то момент может попасться, упомянутая выше, уже зарегистрированная заявка, более того дальше они могут идти в перемешку уже зарегистрированные и новые по одной цене и одному направлению (как в примере 2). Для таких заявок действуют разные правила: уже зарегистрированная может быть сматчена на правах мэйкера, по зарегистрированной цене, а новая: с одной стороны может быть усреднена, а с другой стороны не может быть сматчена на условиях лучше чем та что старше по времени по такой же цене!

Таким образом становиться очевидно как матчить в пределах b - a, усредняя цены новых заявок ограничивая рамками B-A, и как матчить за b и за a - совершая по фиксированной цене для всех заявок в направлении мэйкера. Остаётся одна мелочь, определить какая сторона будет мэйкером: для этого нам необходимо оценить потенциал покупателей и продавцов - это то как на нах воздействует противоположная кумулятивная функция, иными словами 
Q_b = K_b(A) - потенциал покупателя, 
Q_a = K_a(B) - потенциал продавца


Зная потенциал, расположение B, A по отношению к текущим b, a в стакане - мы можем понимать к какому типу относится книга и как её матчить:

1. Q_b > Q_a, a=A (продавцы в роли мэйкера)
2. Q_b > Q_a, A>a (продавцы в роли мэйкера с движением a-A)
3. Q_b < Q_a, b=B (покупатели в роли мэйкера)
4. Q_b < Q_a, B<b (покупатели в роли мэйкера с движением b-B)
5. Q_b = Q_a (сделки не затрагивают спред)
